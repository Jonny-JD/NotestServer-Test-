name: CI/CD Autotests

on:
  workflow_dispatch:

jobs:
  build: 
    runs-on: self-hosted
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      IMAGE_SHA: ${{ github.sha }}
      BACKEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/notes-backend:${{ github.sha }}-test
      FRONTEND_IMAGE: ${{ secrets.DOCKERHUB_USERNAME }}/notes-frontend:${{ github.sha }}-test

    
    steps:
    - name: Checkout autotests repo
      uses: actions/checkout@v4

    - name: Clone frontend
      uses: actions/checkout@v4
      with:
        repository: Jonny-JD/NotesServer-F-
        ref: test
        path: frontend
        
    - name: Clone backend
      uses: actions/checkout@v4
      with:
        repository: Jonny-JD/NotesServer-B-
        ref: test
        path: backend
        
    - name: Reset Docker config
      run: |
        rm -f ~/.docker/config.json
        echo "{\"auths\":{\"https://index.docker.io/v1/\":{\"auth\":\"$(echo -n "${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }}" | base64)\"}}}" > ~/.docker/config.json

    - name: Run make frontend build
      env: 
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        GITHUB_SHA: ${{ github.sha }}
      run: DOCKER_BUILDKIT=0 make -C frontend build-test

    - name: Make gradlew executable
      run: chmod +x backend/gradlew
  
    - name: Run make backend build
      env: 
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        GITHUB_SHA: ${{ github.sha }}
      run: DOCKER_BUILDKIT=0 make -C backend build-test
      
    - name: Run make frontend push
      env: 
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: make -C frontend push-test
    
    - name: Run make backend push
      env: 
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: make -C backend push-test
    
    - name: Kube config
      run: |
        mkdir -p ~/.kube
        echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
      
    - name: Run make create test namespace
      run: make create-test-namespace
    
    - name: Run make create secrets
      run: make create-secrets
      
    - name: Run make deploy test backend
      run: make deploy-test-backend
      env:
        IMAGE_NAME: ${{ env.BACKEND_IMAGE }}

    - name: Run make deploy test frontend
      run: make deploy-test-frontend
      env:
        IMAGE_NAME: ${{ env.FRONTEND_IMAGE }}

    - name: Wait for backend rollout
      run: kubectl rollout status deployment/backend -n test

    - name: Wait for frontend rollout
      run: kubectl rollout status deployment/frontend -n test
      
    - name: Run make cleanup-namespace
      run: make cleanup-namespace
